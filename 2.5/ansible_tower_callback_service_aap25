<%#
kind: snippet
name: ansible_tower_callback_timer_aap25
model: ProvisioningTemplate
snippet: true
description: |
  Systemd timer for retrying AAP provisioning callback on boot.
-%>
[Unit]
Description=Retry provisioning callback to AAP

[Timer]
OnBootSec=2min
OnUnitActiveSec=1min
AccuracySec=30s
Persistent=true

[Install]
WantedBy=timers.target

add ansible_extra_vars: '{"ansible_debug_callback": true}' to enable debug

<%#
kind: snippet
name: ansible_tower_callback_timer_aap25
model: ProvisioningTemplate
snippet: true
description: |
  Systemd timer for retrying AAP provisioning callback on boot.
-%>
[Unit]
Description=Provisioning callback to Ansible Tower
Wants=network-online.target cloud-init.target
After=network-online.target cloud-init.target

[Service]
Type=oneshot
ExecStart=/usr/bin/curl -k -s --data "host_config_key=<%= host_param('ansible_host_config_key') -%>" \
  https://<%= host_param('ansible_tower_fqdn') -%>/api/v2/job_templates/<%= host_param('ansible_job_template_id') -%>/callback/
ExecStartPost=/usr/bin/systemctl disable ansible-callback

[Install]
WantedBy=multi-user.target
